import chalk from 'chalk';
import ora from 'ora';
import { promises as fs } from 'fs';
import { homedir } from 'os';
import { join, dirname } from 'path';

/**
 * Setup Cursor IDE configuration
 * Creates .cursorrules template and workspace settings
 */
export async function setupCursor(answers) {
  const spinner = ora('Configuring Cursor IDE...').start();

  try {
    // Create global .cursorrules
    const cursorrules = `# ${answers.studentName}'s Cursor Rules for Context Engineering Course

## Course Project Standards

When working with course projects:

- Follow course coding standards and patterns
- Use detailed comments to explain AI decisions
- Prefer explicit over implicit code
- Write tests for all new features
- Use meaningful variable names and functions

## AI Behavior Guidelines

Context Engineering Principles:
- Always explain your reasoning before generating code
- Ask for clarification when requirements are unclear
- Suggest multiple approaches for complex problems
- Highlight potential issues or edge cases
- Measure and report token usage when possible

## Model Selection Guidance

Choose the right model for the task:
- **GPT-5**: Complex logic, architecture decisions, system design
- **Claude Sonnet 4.5**: Code refactoring, optimization, code quality
- **Gemini 2.5 Pro**: Creative solutions, exploration, brainstorming
- **Composer**: Multi-file changes, project-wide edits, batch operations

## Context Management

Progressive Disclosure Pattern:
- Don't load all files upfront
- Use symbol-level operations when available (via Serena MCP)
- Load documentation on-demand (via Archon MCP)
- Keep context window focused and relevant

## Code Quality Standards

- Always handle errors gracefully
- Validate inputs before processing
- Use environment variables for secrets (never hardcode)
- Follow OWASP Top 10 security practices
- Write self-documenting code with clear variable names

## Testing Requirements

- Write tests for all new functionality
- Aim for 80%+ code coverage
- Test edge cases and error scenarios
- Use appropriate testing frameworks

## BMAD Integration (if using BMAD framework)

When BMAD agents are active:
- Follow agent-specific guidelines
- Respect workflow structures
- Use prescribed templates
- Maintain separation of concerns

---

Generated by: cursor-claude-setup-2025
Course: Context Engineering Mastery
Student: ${answers.studentName}
`;

    // Write global .cursorrules to home directory
    const cursorrulepath = join(homedir(), '.cursorrules');
    await fs.writeFile(cursorrulepath, cursorrules, 'utf-8');

    spinner.text = 'Creating workspace settings template...';

    // Create Cursor workspace settings template
    const workspaceSettings = {
      'cursor.ai.model': 'claude-sonnet-4.5',
      'cursor.ai.autoSuggestions': true,
      'cursor.ai.enableContextualEditing': true,
      'cursor.ai.longContextMode': false,
      'cursor.general.gitDiffMode': true,
      'editor.fontSize': 14,
      'editor.tabSize': 2,
      'editor.formatOnSave': true,
      'files.autoSave': 'afterDelay',
      'files.autoSaveDelay': 1000,
    };

    // Save template for students to copy to their projects
    const templateDir = join(__dirname, '..', 'templates');
    await fs.mkdir(templateDir, { recursive: true });

    const templatePath = join(templateDir, 'cursor-workspace-settings.json');
    await fs.writeFile(templatePath, JSON.stringify(workspaceSettings, null, 2), 'utf-8');

    spinner.succeed('Cursor configured successfully');
    console.log(chalk.gray(`  • Global .cursorrules: ${cursorrulepath}`));
    console.log(chalk.gray(`  • Workspace template: ${templatePath}`));
    console.log(chalk.gray('  • To apply to project: Copy template to .vscode/settings.json'));
  } catch (error) {
    spinner.fail('Cursor configuration failed');
    console.error(chalk.red(`  Error: ${error.message}`));
    throw error;
  }
}
