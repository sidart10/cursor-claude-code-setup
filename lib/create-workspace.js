import { promises as fs } from 'fs';
import { join } from 'path';
import { homedir } from 'os';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import chalk from 'chalk';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Create student workspace folder structure
 * Organized by week/module with proper directories
 * Includes MCP configuration templates
 */
export async function createWorkspace(studentName) {
  const workspaceRoot = join(homedir(), 'cursor-claude-course');

  // Create main workspace directory
  await fs.mkdir(workspaceRoot, { recursive: true });

  // Create week/module folders
  const folders = [
    'week-1-foundations',
    'week-2-cursor-advanced',
    'week-3-claude-mastery',
    'week-4-mcp-ecosystem',
    'week-5-context-engineering',
    'week-6-prp-bmad-advanced',
    'week-7-production',
    'week-8-advanced',
    'capstone-projects/project-1-multi-agent',
    'capstone-projects/project-2-pydantic-agent',
    'capstone-projects/project-3-agent-factory',
    'capstone-projects/project-4-custom-mcp',
    'resources',
    'notes',
  ];

  for (const folder of folders) {
    await fs.mkdir(join(workspaceRoot, folder), { recursive: true });
  }

  // Create main README
  const readme = `# Context Engineering Mastery - ${studentName}'s Workspace

Welcome to your course workspace! This folder is organized by week to help you track progress.

## Folder Structure

- **week-1-foundations/** - Module 1 exercises and projects
- **week-2-cursor-advanced/** - Module 2 exercises
- **week-3-claude-mastery/** - Module 3 exercises
- **week-4-mcp-ecosystem/** - Module 4 exercises
- **week-5-context-engineering/** - Module 5 exercises
- **week-6-prp-bmad-advanced/** - Modules 6 exercises
- **week-7-production/** - Module 7 exercises
- **week-8-advanced/** - Module 8 exercises
- **capstone-projects/** - Your 4 portfolio projects
- **resources/** - Cheat sheets, templates, references
- **notes/** - Your personal notes and learnings

## Getting Started

1. Clone the course repository:
   \`\`\`bash
   git clone https://github.com/YOUR-ORG/cursor-claude-mastery-2025
   \`\`\`

2. Start with Module 1:
   - Read: cursor-claude-mastery-2025/modules/module-01-foundations/README.md
   - Watch: Lesson 1.1 in course platform
   - Complete exercises in: week-1-foundations/

3. Track your progress:
   - Use .course-progress.json (auto-generated)
   - Or: npx cursor-claude-progress

## Quick Links

- Course Platform: [Your course platform URL]
- Main Repository: https://github.com/YOUR-ORG/cursor-claude-mastery-2025
- Discord Community: [Discord invite]
- Troubleshooting: See course repository docs/troubleshooting/

## Tools Installed

- ✅ Cursor IDE (configured with .cursorrules)
- ✅ Claude Code CLI (with MCP servers)
- ✅ Archon MCP Server (http://localhost:3737)
- ✅ Serena MCP Server (on-demand)
- ✅ BMAD Framework (12 agents, 34 workflows)

## Next Steps

1. Open Cursor IDE
2. Create a test project in week-1-foundations/
3. Try Tab autocomplete and Cmd+K
4. Test Claude Code: \`claude "What tools do I have?"\`
5. Start Lesson 1.1 in course platform

Happy learning!

---
Generated by: cursor-claude-setup-2025
Student: ${studentName}
`;

  await fs.writeFile(join(workspaceRoot, 'README.md'), readme, 'utf-8');

  // Create .course-progress.json
  const progress = {
    student: studentName,
    started: new Date().toISOString().split('T')[0],
    progress: {
      'module-01': { status: 'not-started', current_lesson: '1.1' },
      'module-02': { status: 'not-started' },
      'module-03': { status: 'not-started' },
      'module-04': { status: 'not-started' },
      'module-05': { status: 'not-started' },
      'module-06': { status: 'not-started' },
      'module-07': { status: 'not-started' },
      'module-08': { status: 'not-started' },
    },
    capstones: {
      'capstone-1': { status: 'not-started' },
      'capstone-2': { status: 'not-started' },
      'capstone-3': { status: 'not-started' },
      'capstone-4': { status: 'not-started' },
    },
  };

  await fs.writeFile(join(workspaceRoot, '.course-progress.json'), JSON.stringify(progress, null, 2), 'utf-8');

  // Copy MCP templates to workspace
  const templatesDir = join(__dirname, '..', 'templates');

  try {
    // Copy .mcp.json template
    const mcpTemplateSrc = join(templatesDir, '.mcp.json');
    const mcpTemplateDest = join(workspaceRoot, 'resources', '.mcp.json.template');
    const mcpContent = await fs.readFile(mcpTemplateSrc, 'utf-8');
    await fs.writeFile(mcpTemplateDest, mcpContent, 'utf-8');

    // Copy Cursor MCP template if exists
    try {
      const cursorMcpSrc = join(templatesDir, 'cursor-mcp.json');
      const cursorMcpDest = join(workspaceRoot, 'resources', '.cursormcp.template');
      const cursorMcpContent = await fs.readFile(cursorMcpSrc, 'utf-8');
      await fs.writeFile(cursorMcpDest, cursorMcpContent, 'utf-8');
    } catch {
      // Cursor MCP not created (component not selected)
    }

    // Create MCP setup guide
    const mcpGuide = `# MCP Server Configuration Guide

This folder contains templates for configuring MCP servers in your projects.

## What is .mcp.json?

\`.mcp.json\` is a **project-level** configuration file that tells Claude Code which MCP servers to use for THIS specific project.

## Global vs Project Config

**Global Config** (~/.claude/config.json):
- Applies to ALL projects
- Good for: Servers you always want (Archon, Serena)
- Edited with: \`claude mcp add\` or manually

**Project Config** (.mcp.json in project root):
- Applies ONLY to this project
- Good for: Project-specific servers, custom tools
- Edited manually in your project

**Priority:** Project config overrides global config

## Using the Templates

### For Claude Code Projects

1. Copy template to your project:
   \`\`\`bash
   cp resources/.mcp.json.template /path/to/your/project/.mcp.json
   \`\`\`

2. Edit as needed:
   \`\`\`bash
   code /path/to/your/project/.mcp.json
   \`\`\`

3. Restart Claude Code or reload project

### For Cursor Projects

1. Copy template to your project:
   \`\`\`bash
   cp resources/.cursormcp.template /path/to/your/project/.cursormcp
   \`\`\`

2. Edit as needed

3. Restart Cursor IDE

## Example: Custom Project with Only Serena

\`\`\`json
{
  "mcpServers": {
    "serena": {
      "command": "uvx",
      "args": [
        "--from",
        "git+https://github.com/oraios/serena",
        "serena",
        "start-mcp-server",
        "--context",
        "ide-assistant"
      ]
    }
  }
}
\`\`\`

## Adding More MCP Servers

Explore MCP servers at: https://github.com/modelcontextprotocol/servers

**Example: Add Filesystem MCP**
\`\`\`json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem",
        "/path/to/allowed/directory"
      ]
    }
  }
}
\`\`\`

## Course Exercises

**Week 4 - Module 4:**
- Exercise 4.1: Configure project-level MCP servers
- Exercise 4.2: Add custom MCP server to project
- Exercise 4.3: Global vs project config comparison

**Week 8 - Module 8:**
- Capstone 4: Build your own MCP server

---

Generated by: cursor-claude-setup-2025
`;

    await fs.writeFile(join(workspaceRoot, 'resources', 'MCP-SETUP-GUIDE.md'), mcpGuide, 'utf-8');
  } catch (copyError) {
    // Templates might not exist yet (race condition), that's okay
    console.log(chalk.gray('  Note: MCP templates will be available after setup completes'));
  }

  return workspaceRoot;
}
