import chalk from 'chalk';
import ora from 'ora';
import { promises as fs } from 'fs';
import { execSync } from 'child_process';
import { join } from 'path';
import { homedir } from 'os';
import inquirer from 'inquirer';
import clipboardy from 'clipboardy';

/**
 * Setup Archon MCP Server
 * Most complex setup - Docker + Supabase + migration
 */
export async function setupArchon(answers) {
  const spinner = ora('Setting up Archon MCP Server...').start();

  try {
    // Verify Docker is running
    spinner.text = 'Checking Docker...';
    try {
      execSync('docker ps', { stdio: 'pipe' });
    } catch {
      spinner.fail('Docker not running');
      console.log(chalk.yellow('\n‚ö†Ô∏è  Start Docker Desktop and run installer again\n'));
      throw new Error('Docker required for Archon');
    }

    // Clone Archon (stable branch)
    spinner.text = 'Cloning Archon repository...';

    const archonPath = join(homedir(), 'cursor-claude-course', 'archon');

    // Check if already exists
    try {
      await fs.access(archonPath);
      spinner.text = 'Archon directory exists, using existing...';
    } catch {
      // Doesn't exist, clone it
      execSync(`git clone -b stable https://github.com/coleam00/archon.git "${archonPath}"`, { stdio: 'pipe' });
    }

    // Create .env file
    spinner.text = 'Creating environment configuration...';

    const envContent = `# Archon Configuration
# Generated by cursor-claude-setup-2025 on ${new Date().toISOString().split('T')[0]}
# Student: ${answers.studentName}

# ==========================================
# Supabase Configuration
# ==========================================
SUPABASE_URL=${answers.supabaseUrl}
${answers.supabaseKey ? `SUPABASE_SERVICE_KEY=${answers.supabaseKey}` : '# SUPABASE_SERVICE_KEY=your-key-here'}

# ==========================================
# LLM Configuration
# ==========================================
# OpenAI (for embeddings and LLM)
${answers.openaiKey ? `OPENAI_API_KEY=${answers.openaiKey}` : '# OPENAI_API_KEY=sk-your-key-here'}

# Uncomment for alternative providers:
# GEMINI_API_KEY=your-gemini-key-here
# OLLAMA_URL=http://host.docker.internal:11434

# ==========================================
# üìù Add Your API Keys Later
# ==========================================
# Get API keys from:
# - OpenAI: https://platform.openai.com/api-keys
# - Supabase: https://supabase.com/dashboard/project/_/settings/api
#
# Then uncomment and fill in the keys above, or run:
# cursor-claude-setup-2025 --configure-keys

# ==========================================
# Port Configuration (defaults)
# ==========================================
ARCHON_UI_PORT=3737
ARCHON_SERVER_PORT=8181
ARCHON_MCP_PORT=8051
ARCHON_AGENTS_PORT=8052

# ==========================================
# Hostname Configuration
# ==========================================
HOST=localhost

# ==========================================
# Optional: Agent Work Orders
# ==========================================
# AGENT_WORK_ORDERS_PORT=8053
# Uncomment to enable workflow automation engine
`;

    await fs.writeFile(join(archonPath, '.env'), envContent, 'utf-8');

    // Handle Supabase migration
    spinner.stop();

    console.log(chalk.cyan('\n  üìä Supabase Database Setup\n'));
    console.log(chalk.white('  You need to run a SQL migration in Supabase.\n'));

    const migrationPath = join(archonPath, 'migration', 'complete_setup.sql');
    const migrationSql = await fs.readFile(migrationPath, 'utf-8');

    // Copy migration SQL to clipboard
    try {
      await clipboardy.write(migrationSql);
      console.log(chalk.green('  ‚úì Migration SQL copied to clipboard\n'));
    } catch {
      console.log(chalk.gray(`  Migration SQL location: ${migrationPath}\n`));
    }

    console.log(chalk.yellow('  üìù Manual Steps Required:\n'));
    console.log(chalk.white('  1. Open https://supabase.com ‚Üí Your Project ‚Üí SQL Editor'));
    console.log(chalk.white('  2. Paste the migration SQL (from clipboard)'));
    console.log(chalk.white('  3. Click "Run" and wait ~30 seconds'));
    console.log(chalk.white('  4. Verify: Should see "Success. No rows returned"\n'));

    const { migrationDone } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'migrationDone',
        message: 'Migration completed in Supabase?',
        default: false,
      },
    ]);

    if (!migrationDone) {
      console.log(chalk.yellow('\n  ‚ö†Ô∏è  Complete migration before starting Archon'));
      console.log(chalk.gray('  You can start Archon later with:'));
      console.log(chalk.gray(`  cd ${archonPath} && docker compose up -d\n`));
      throw new Error('Database migration not completed');
    }

    // Start Docker containers
    spinner.start();
    spinner.text = 'Starting Archon services (first build: 2-5 minutes)...';

    execSync('docker compose up --build -d', {
      cwd: archonPath,
      stdio: 'pipe',
    });

    // Wait for services
    spinner.text = 'Waiting for services to initialize...';
    await new Promise((resolve) => setTimeout(resolve, 20000)); // 20 second wait

    // Check if UI is accessible
    try {
      const response = await fetch('http://localhost:3737', {
        signal: AbortSignal.timeout(10000),
      });

      if (response.ok) {
        spinner.succeed('Archon running successfully!');
        console.log(chalk.green('  ‚Ä¢ Web UI: http://localhost:3737'));
        console.log(chalk.green('  ‚Ä¢ MCP Server: http://localhost:8051'));
        console.log(chalk.green('  ‚Ä¢ All 4 containers healthy'));

        console.log(chalk.cyan('\n  üéØ Next: Open http://localhost:3737'));
        console.log(chalk.white('  - Complete onboarding wizard'));
        console.log(chalk.white('  - Crawl your first documentation site'));
        console.log(chalk.white('  - Test RAG search via Claude Code\n'));
      } else {
        throw new Error('UI not responding');
      }
    } catch (fetchError) {
      spinner.warn('Archon started but UI not ready yet');
      console.log(chalk.yellow('  ‚è±  Give it another 1-2 minutes'));
      console.log(chalk.gray('  Then check: http://localhost:3737\n'));

      console.log(chalk.cyan('  Check status:'));
      console.log(chalk.gray('  docker ps --filter name=archon\n'));
    }
  } catch (error) {
    spinner.fail('Archon setup failed');
    console.error(chalk.red(`  Error: ${error.message}`));

    console.log(chalk.yellow('\n  Troubleshooting:'));
    console.log(chalk.white('  1. Verify Docker Desktop is running'));
    console.log(chalk.white('  2. Check Supabase credentials are correct'));
    console.log(chalk.white('  3. Ensure ports 3737, 8051, 8052, 8181 are available'));
    console.log(chalk.white('  4. Check logs: docker compose logs -f'));
    console.log(chalk.white(`  5. Manual setup: ${archonPath}/README.md\n`));

    throw error;
  }
}
